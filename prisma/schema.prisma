generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model AIInsight {
  id         String   @id
  userId     String
  leadId     String?
  type       String
  message    String
  confidence Float    @default(0.5)
  action     String?
  priority   String   @default("MEDIUM")
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  Lead       Lead?    @relation(fields: [leadId], references: [id])
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([priority])
  @@index([read])
  @@index([type])
  @@index([userId])
}

model AIPrediction {
  id            String   @id
  userId        String
  date          DateTime
  expectedSales Int
  scenario      String
  confidence    Float    @default(0.5)
  metadata      Json?
  createdAt     DateTime @default(now())
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([date])
  @@index([scenario])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model AiLog {
  id          String   @id
  leadId      String?
  userId      String
  prompt      String
  response    Json
  model       String   @default("gpt-4o-mini")
  tokens      Int?
  score       Int?
  segment     String?
  probability Float?
  createdAt   DateTime @default(now())
  Lead        Lead?    @relation(fields: [leadId], references: [id])
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([model])
  @@index([userId])
}

model Alert {
  id        String   @id
  userId    String
  leadId    String?
  type      String
  title     String
  message   String
  priority  String   @default("MEDIUM")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  Lead      Lead?    @relation(fields: [leadId], references: [id])
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([priority])
  @@index([read])
  @@index([type])
  @@index([userId])
}

model ApiKey {
  id        String    @id
  userId    String
  key       String    @unique
  name      String?
  active    Boolean   @default(true)
  lastUsed  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([key])
  @@index([userId])
}

model BusinessProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  sector    String
  name      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RestaurantMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  salesToday      Float?
  openTickets     Int?
  tablesOccupied  Int?
  activeEmployees Int?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model GymMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  activeMembers   Int?
  renewals        Int?
  todayCheckins   Int?
  pendingPayments Int?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model WorkshopMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  openOrders      Int?
  vehiclesOnSite  Int?
  monthlyRevenue  Float?
  deliveriesToday Int?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model RealEstateMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  activeLeads     Int?
  visitsToday     Int?
  monthlyClosings Int?
  commissions     Float?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model RetailMetrics {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime @default(now())
  dailySales    Float?
  lowStock      Int?
  averageTicket Float?
  suppliers     Int?
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model HomeServiceMetrics {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @default(now())
  appointmentsToday Int?
  activeTechnicians Int?
  pendingInvoices   Int?
  closedJobs        Int?
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model EventMetrics {
  id             String   @id @default(cuid())
  userId         String
  date           DateTime @default(now())
  reservations   Int?
  capacity       Int?
  revenue        Float?
  upcomingEvents Int?
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model GenericMetrics {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime @default(now())
  totalRevenue  Float?
  activeClients Int?
  openTasks     Int?
  satisfaction  Float?
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model CalendarEvent {
  id            String        @id
  userId        String
  clientId      String?
  title         String
  type          EventType
  status        EventStatus   @default(PENDING)
  start         DateTime
  end           DateTime
  priority      EventPriority @default(MEDIUM)
  source        EventSource   @default(MANUAL)
  notes         String?
  assignedTo    String?
  reminders     Int[]         @default([])
  color         String?       @default("bg-blue-500")
  clientName    String?
  clientEmail   String?
  clientPhone   String?
  googleEventId String?       @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  Client        Client?       @relation(fields: [clientId], references: [id])
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([googleEventId])
  @@index([start])
  @@index([status])
  @@index([type])
  @@index([userId])
}

model Client {
  id                  String          @id @default(cuid())
  userId              String
  name                String?
  email               String?
  phone               String?
  notes               String?
  totalSpent          Float           @default(0)
  currency            String          @default("EUR")
  source              String?
  page                String?
  conversionSource    String?
  conversionProduct   String?
  convertedFromLeadId String?
  firstScore          Int             @default(0)
  initialScore        Int             @default(0)
  finalScore          Int             @default(0)
  conversionTime      Int?
  timeToConvert       Int?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  status              String          @default("ACTIVE")
  clientTraits        String[]        @default([])
  riskLevel           String?         @default("LOW")
  CalendarEvent       CalendarEvent[]
  User                User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads               Lead[]          @relation("ClientLeads")
  Sale                Sale[]
  Task                Task[]
  transactions        Transaction[]

  @@index([createdAt])
  @@index([email])
  @@index([page])
  @@index([source])
  @@index([userId])
  @@index([convertedFromLeadId])
  @@index([status])
}

model Event {
  id        String   @id
  leadId    String?
  userId    String
  type      String
  url       String
  element   Json?
  data      Json
  sessionId String?
  visitorId String?
  createdAt DateTime @default(now())
  Lead      Lead?    @relation(fields: [leadId], references: [id])
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([sessionId])
  @@index([type])
  @@index([userId])
  @@index([visitorId])
}

model FinancialRecord {
  id            String   @id
  userId        String
  type          String
  amount        Float
  category      String
  paymentMethod String
  date          DateTime @default(now())
  note          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([date])
  @@index([type])
  @@index([userId])
}

model Lead {
  id                    String          @id @default(cuid())
  userId                String
  websiteId             String?
  email                 String?
  name                  String?
  phone                 String?
  message               String?
  source                String          @default("WEB")
  formId                String?
  status                String          @default("NEW")
  leadStatus            LeadStatus      @default(NEW)
  temperature           LeadTemp?
  page                  String?
  lastAction            String?
  lastActionAt          DateTime?
  actions               Json?
  aiPrediction          Float?
  aiReasoning           String?
  aiSegment             String?
  converted             Boolean         @default(false)
  validationStatus      String          @default("PENDING")
  category              String?
  priority              String          @default("MEDIUM")
  tags                  String[]        @default([])
  notes                 String?
  ip                    String?
  country               String?
  device                String?
  userAgent             String?
  spamScore             Float           @default(0)
  score                 Int             @default(0)
  stageId               String?
  interactions          Json?
  conversionProbability Float?
  aiUrgency             String?
  aiLastCheck           DateTime?
  finalScore            Int?
  conversionTime        Int?
  metadata              Json?
  clientId              String?
  convertedAt           DateTime?
  conversionSource      String?
  conversionProduct     String?
  allowedDomain         String?
  aiReason              String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  AIInsight             AIInsight[]
  activities            Activity[]
  aiInsights            AiInsight[]
  AiLog                 AiLog[]
  Alert                 Alert[]
  Event                 Event[]
  client                Client?         @relation("ClientLeads", fields: [clientId], references: [id])
  stage                 PipelineStage?  @relation(fields: [stageId], references: [id])
  User                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  Website               Website?        @relation(fields: [websiteId], references: [id])
  LeadAIInsight         LeadAIInsight?
  LeadAlert             LeadAlert[]
  LeadEvent             LeadEvent[]
  leadScores            LeadScore[]
  Task                  Task[]
  TrackingEvent         TrackingEvent[]

  @@index([category])
  @@index([clientId])
  @@index([converted])
  @@index([createdAt])
  @@index([email])
  @@index([formId])
  @@index([ip])
  @@index([lastActionAt])
  @@index([leadStatus])
  @@index([page])
  @@index([priority])
  @@index([score])
  @@index([stageId])
  @@index([source])
  @@index([status])
  @@index([temperature])
  @@index([userId])
  @@index([validationStatus])
  @@index([websiteId])
}

model LeadAIInsight {
  id            String   @id
  leadId        String   @unique
  userId        String
  probability   Float
  urgency       String
  explanation   String
  actions       Json
  estimatedTime Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  Lead          Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([probability])
  @@index([urgency])
  @@index([userId])
}

model LeadAlert {
  id          String    @id
  leadId      String
  userId      String
  type        AlertType
  message     String
  reason      String?
  triggeredAt DateTime  @default(now())
  seen        Boolean   @default(false)
  Lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([seen])
  @@index([triggeredAt])
  @@index([type])
  @@index([userId])
}

model LeadEvent {
  id        String   @id
  leadId    String
  userId    String
  type      String
  data      Json
  timestamp DateTime @default(now())
  Lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([timestamp])
  @@index([type])
  @@index([userId])
}

model Notification {
  id        String   @id
  userId    String
  title     String
  message   String
  type      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([read])
  @@index([userId])
}

model Post {
  id          String    @id
  title       String
  slug        String    @unique
  content     String
  excerpt     String?
  category    String    @default("updates")
  published   Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime

  @@index([category])
  @@index([publishedAt])
  @@index([published])
  @@index([slug])
}

model Sale {
  id               String   @id
  userId           String
  clientId         String?
  clientName       String
  clientEmail      String?
  product          String
  category         String?
  price            Float
  discount         Float    @default(0)
  tax              Float    @default(0)
  total            Float
  amount           Float?
  currency         String   @default("EUR")
  provider         String   @default("STRIPE")
  paymentMethod    String
  status           String   @default("PAGADO")
  stripePaymentId  String?
  stripeCustomerId String?
  metadata         Json?
  notes            String?
  saleDate         DateTime @default(now())
  invoiceUrl       String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  Client           Client?  @relation(fields: [clientId], references: [id])
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([paymentMethod])
  @@index([saleDate])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripePaymentId])
  @@index([userId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TrackingEvent {
  id        String   @id
  userId    String
  leadId    String?
  sessionId String
  type      String
  page      String
  element   String?
  value     Int?
  metadata  Json?
  createdAt DateTime @default(now())
  Lead      Lead?    @relation(fields: [leadId], references: [id])
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([page])
  @@index([sessionId])
  @@index([type])
  @@index([userId])
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  name                   String?
  password               String?
  phone                  String?
  emailVerified          DateTime?
  role                   UserRole                @default(USER)
  plan                   PlanType                @default(FREE)
  onboardingCompleted    Boolean                 @default(false)
  selectedSector         String?
  planId                 String?
  isTrial                Boolean                 @default(true)
  planStartedAt          DateTime                @default(now())
  planExpiresAt          DateTime?
  billingCycle           String?
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  image                  String?
  isBlocked              Boolean                 @default(false)
  isActive               Boolean                 @default(true)
  blockedAt              DateTime?
  blockedReason          String?
  lastLoginAt            DateTime?
  lastActiveAt           DateTime?
  AIInsight              AIInsight[]
  AIPrediction           AIPrediction[]
  accounts               Account[]
  activities             Activity[]
  aiInsights             AiInsight[]
  AiLog                  AiLog[]
  Alert                  Alert[]
  ApiKey                 ApiKey[]
  automations            Automation[]
  automationLogs         AutomationLog[]
  budgets                Budget[]
  BusinessProfile        BusinessProfile?
  CalendarEvent          CalendarEvent[]
  cashflowForecasts      CashflowForecast[]
  Client                 Client[]
  Event                  Event[]
  eventMetrics           EventMetrics[]
  financeAlerts          FinanceAlert[]
  financialGoals         FinancialGoal[]
  FinancialRecord        FinancialRecord[]
  fixedExpenses          FixedExpense[]
  genericMetrics         GenericMetrics[]
  gymMetrics             GymMetrics[]
  homeServiceMetrics     HomeServiceMetrics[]
  integrations           Integration[]
  integrationLogs        IntegrationLog[]
  Lead                   Lead[]
  LeadAIInsight          LeadAIInsight[]
  LeadAlert              LeadAlert[]
  LeadEvent              LeadEvent[]
  leadScores             LeadScore[]
  Notification           Notification[]
  payments               Payment[]
  pipelineStages         PipelineStage[]
  providers              Provider[]
  providerContactLogs    ProviderContactLog[]
  providerFiles          ProviderFile[]
  providerNotes          ProviderNote[]
  providerOrders         ProviderOrder[]
  providerPayments       ProviderPayment[]
  providerTasks          ProviderTask[]
  providerTimelineEvents ProviderTimelineEvent[]
  realEstateMetrics      RealEstateMetrics[]
  restaurantMetrics      RestaurantMetrics[]
  retailMetrics          RetailMetrics[]
  Sale                   Sale[]
  monthlyGoals           MonthlyGoal[]
  services               Service[]
  sessions               Session[]
  subscriptions          Subscription[]
  Task                   Task[]
  TaskCalendarSync       TaskCalendarSync[]
  teamMembers            TeamMember[]
  TrackingEvent          TrackingEvent[]
  transactions           Transaction[]
  planRelation           Plan?                   @relation(fields: [planId], references: [id])
  Website                Website[]
  workshopMetrics        WorkshopMetrics[]
  adminLogs              AdminLog[]              @relation("AdminLogs")
  impersonatedBy         ImpersonationSession[]  @relation("ImpersonatedBy")
  impersonationTarget    ImpersonationSession[]  @relation("ImpersonationTarget")
  UserWorkingHours       UserWorkingHours[]
  UserTimeOff            UserTimeOff[]
  CalendarBlock          CalendarBlock[]
  Reminder               Reminder[]
}

model UserWorkingHours {
  id     String   @id @default(cuid())
  userId String
  weekday Int     // 0 = Sunday, 1 = Monday, ... 6 = Saturday
  start  DateTime // time-of-day (use date part as reference only)
  end    DateTime
  User   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, weekday])
}

model UserTimeOff {
  id     String    @id @default(cuid())
  userId String
  start  DateTime
  end    DateTime
  reason String?
  User   User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CalendarBlock {
  id     String    @id @default(cuid())
  userId String
  start  DateTime
  end    DateTime
  reason String?
  User   User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Reminder {
  id        String       @id @default(cuid())
  userId    String
  title     String
  start     DateTime
  end       DateTime
  status    ReminderStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  User      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([start])
  @@index([status])
}

model MonthlyGoal {
  id        String   @id @default(cuid())
  userId    String
  month     Int
  year      Int
  amount    Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId])
  @@index([month, year])
}

model Plan {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isPublic    Boolean  @default(true)
  price       Float?
  features    String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]

  @@map("plans")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Website {
  id            String        @id
  userId        String
  name          String
  template      String        @default("default")
  business_type String        @default("default")
  city          String        @default("")
  phone         String?
  whatsapp      String?
  email         String?
  services      String[]      @default([])
  description   String?
  status        String        @default("draft")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  palette       Json?
  Lead          Lead[]
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  WebsitePage   WebsitePage[]

  @@index([business_type])
  @@index([status])
  @@index([template])
  @@index([userId])
}

model WebsitePage {
  id        String   @id
  websiteId String
  slug      String
  title     String
  content   Json
  createdAt DateTime @default(now())
  Website   Website  @relation(fields: [websiteId], references: [id], onDelete: Cascade)
}

model Transaction {
  id            String            @id @default(cuid())
  userId        String
  type          TransactionType
  amount        Float
  concept       String
  category      String
  clientId      String?
  paymentMethod String
  status        TransactionStatus @default(PENDING)
  origin        TransactionOrigin @default(MANUAL)
  date          DateTime
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  Client        Client?           @relation(fields: [clientId], references: [id])
  User          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([clientId])
  @@index([date])
  @@index([origin])
  @@index([status])
  @@index([type])
  @@index([userId])
}

model FixedExpense {
  id          String           @id @default(cuid())
  userId      String
  name        String
  amount      Float
  frequency   ExpenseFrequency
  nextPayment DateTime
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  User        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([frequency])
  @@index([nextPayment])
  @@index([userId])
}

model Budget {
  id        String       @id @default(cuid())
  userId    String
  category  String
  limit     Float
  period    BudgetPeriod
  spent     Float        @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  User      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([period])
  @@index([userId])
}

model FinancialGoal {
  id          String       @id @default(cuid())
  userId      String
  title       String
  description String?
  target      Float
  current     Float        @default(0)
  deadline    DateTime
  priority    GoalPriority @default(MEDIUM)
  status      GoalStatus   @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  User        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deadline])
  @@index([priority])
  @@index([status])
  @@index([userId])
}

model FinanceAlert {
  id        String           @id @default(cuid())
  userId    String
  type      FinanceAlertType
  message   String
  severity  AlertSeverity    @default(MEDIUM)
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([read])
  @@index([severity])
  @@index([type])
  @@index([userId])
}

model CashflowForecast {
  id               String   @id @default(cuid())
  userId           String
  date             DateTime
  predictedIncome  Float
  predictedExpense Float
  predictedNet     Float
  confidence       Float
  factors          Json
  createdAt        DateTime @default(now())
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([userId])
}

model TeamMember {
  id        String   @id @default(cuid())
  userId    String
  email     String
  role      String   @default("USER")
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@index([email])
  @@index([userId])
}

model Subscription {
  id                String   @id @default(cuid())
  userId            String
  plan              String
  status            String   @default("ACTIVE")
  stripeSubId       String   @unique
  currentPeriodEnd  DateTime
  cancelAtPeriodEnd Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeSubId])
  @@index([userId])
  @@index([status])
}

model Payment {
  id                    String   @id @default(cuid())
  userId                String
  amount                Int
  currency              String   @default("EUR")
  status                String   @default("PENDING")
  invoiceUrl            String?
  stripePaymentIntentId String?
  createdAt             DateTime @default(now())
  User                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([stripePaymentIntentId])
}

model Integration {
  id         String              @id @default(cuid())
  userId     String
  name       String
  provider   String
  category   IntegrationCategory
  status     IntegrationStatus   @default(DISCONNECTED)
  config     Json?
  apiKey     String?
  webhookUrl String?
  lastSync   DateTime?
  settings   Json?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  User       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs       IntegrationLog[]

  @@index([category])
  @@index([provider])
  @@index([status])
  @@index([userId])
}

model IntegrationLog {
  id            String      @id @default(cuid())
  userId        String
  integrationId String
  type          LogType
  action        String
  data          Json?
  success       Boolean     @default(true)
  error         String?
  metadata      Json?
  createdAt     DateTime    @default(now())
  Integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([integrationId])
  @@index([success])
  @@index([type])
}

model Activity {
  id          String   @id @default(cuid())
  userId      String
  leadId      String
  type        String
  title       String
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())
  Lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadId])
  @@index([createdAt])
  @@index([type])
}

model LeadScore {
  id        String   @id @default(cuid())
  userId    String
  leadId    String
  score     Int
  rule      String
  points    Int
  metadata  Json?
  createdAt DateTime @default(now())
  Lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadId])
  @@index([createdAt])
}

model PipelineStage {
  id        String   @id @default(cuid())
  userId    String
  name      String
  order     Int
  color     String   @default("#6366f1")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  leads     Lead[]
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, order])
  @@index([userId])
}

model Automation {
  id          String          @id @default(cuid())
  userId      String
  name        String
  description String?
  trigger     Json
  actions     Json
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  User        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs        AutomationLog[]

  @@index([userId])
  @@index([active])
}

model AutomationLog {
  id           String     @id @default(cuid())
  userId       String
  automationId String
  leadId       String?
  action       String
  result       String
  error        String?
  executedAt   DateTime   @default(now())
  Automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  User         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([automationId])
  @@index([leadId])
  @@index([executedAt])
}

model AiInsight {
  id         String   @id @default(cuid())
  userId     String
  leadId     String
  type       String
  title      String
  content    String
  confidence Float    @default(0.5)
  metadata   Json?
  createdAt  DateTime @default(now())
  Lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadId])
  @@index([type])
  @@index([createdAt])
}

model AdminLog {
  id          String      @id @default(cuid())
  adminId     String
  adminEmail  String
  action      AdminAction
  targetType  String?
  targetId    String?
  targetEmail String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  admin       User        @relation("AdminLogs", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([targetId])
  @@index([createdAt])
  @@map("admin_logs")
}

model ImpersonationSession {
  id           String    @id @default(cuid())
  adminId      String
  targetUserId String
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  ipAddress    String?
  admin        User      @relation("ImpersonatedBy", fields: [adminId], references: [id], onDelete: Cascade)
  targetUser   User      @relation("ImpersonationTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetUserId])
  @@index([startedAt])
  @@map("impersonation_sessions")
}

model BackupMetadata {
  id           String       @id @default(cuid())
  filename     String
  size         BigInt
  location     String
  triggeredBy  String?
  status       BackupStatus
  type         BackupType
  createdAt    DateTime     @default(now())
  completedAt  DateTime?
  errorMessage String?

  @@index([status])
  @@index([createdAt])
  @@map("backup_metadata")
}

model Task {
  id                    String       @id
  userId                String
  title                 String
  description           String?
  status                TaskStatus   @default(PENDING)
  priority              TaskPriority @default(MEDIUM)
  dueDate               DateTime?
  type                  TaskType     @default(MANUAL)
  clientId              String?
  leadId                String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  // --- New optional fields (backward compatible) ---
  estimatedMinutes      Int?
  slaMinutes            Int?      // SLA en minutos para c√°lculo de cumplimiento
  completedAt           DateTime?
  startedAt             DateTime?
  startAt               DateTime?   // planned start (calendar slot)
  endAt                 DateTime?   // planned end (calendar slot)
  priorityScore         Float?
  lastPriorityCalc      DateTime?
  energyScore           Float?
  financialImpact      Float?
  isBlocking            Boolean?     @default(false)
  blockedReason         String?
  recurrenceRule        String?
  parentTaskId          String?
  sourceModule          String?
  sourceId              String?
  autoGenerated         Boolean?     @default(false)
  completionQualityScore Float?
  assignedTo            String?
  latitude              Float?
  longitude             Float?
  routeOrder            Int?
  // --- Relations (existing unchanged) ---
  Client                Client?      @relation(fields: [clientId], references: [id])
  Lead                  Lead?       @relation(fields: [leadId], references: [id])
  User                  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentTask            Task?        @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: SetNull)
  subtasks              Task[]       @relation("TaskSubtasks")
  calendarSyncs         TaskCalendarSync[]

  @@index([userId])
  @@index([clientId])
  @@index([leadId])
  @@index([status])
  @@index([dueDate])
  @@index([assignedTo])
  @@index([priorityScore])
  @@index([parentTaskId])
  @@index([sourceModule])
  @@index([completedAt])
  @@index([startAt])
  @@index([endAt])
}

model TaskCalendarSync {
  id               String   @id @default(cuid())
  taskId           String
  userId           String
  provider         CalendarSyncProvider
  externalEventId  String
  lastSyncedAt     DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  Task             Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, provider])
  @@index([userId])
  @@index([provider])
}

model CalendarSyncJob {
  id           String                @id @default(cuid())
  taskId       String
  userId       String
  provider     CalendarSyncProvider
  operation    CalendarSyncOperation
  payload      Json?
  status       CalendarSyncJobStatus @default(PENDING)
  errorMessage String?
  attempts     Int                   @default(0)
  maxAttempts  Int                   @default(5)
  nextRetryAt  DateTime?
  createdAt    DateTime              @default(now())
  processedAt  DateTime?

  @@index([status])
  @@index([nextRetryAt])
  @@index([userId])
}

model Provider {
  id                       String                   @id @default(cuid())
  userId                   String
  name                     String
  type                     String?
  status                   ProviderStatus           @default(ACTIVE)
  dependencyLevel          ProviderDependency       @default(LOW)
  operationalState         ProviderOperationalState @default(OK)
  monthlyCost              Float?
  monthlyBudgetLimit       Float?
  lastOrderDate            DateTime?
  averageOrderFrequency    Int?
  estimatedConsumptionRate Float?
  isCritical               Boolean                  @default(false)
  contactEmail             String?
  contactPhone             String?
  website                  String?
  notes                    String?
  reminderInterval         Int?
  lastReminderDate         DateTime?
  emailTemplates           String?
  autoCreateTaskOnRisk     Boolean                  @default(false)
  autoNotifyBeforeRestock  Int?
  autoSuggestOrder         Boolean                  @default(false)
  aiInsightsEnabled        Boolean                  @default(true)
  ignoredInsightIds        String?                  @default("")
  affectedArea             String?
  hasAlternative           Boolean                  @default(true)
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  User                     User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactLogs              ProviderContactLog[]
  files                    ProviderFile[]
  notes_list               ProviderNote[]
  orders                   ProviderOrder[]
  payments                 ProviderPayment[]
  tasks                    ProviderTask[]
  timelineEvents           ProviderTimelineEvent[]
  services                 Service[]                @relation("ProviderToService")

  @@index([userId])
  @@index([status])
  @@index([dependencyLevel])
  @@index([operationalState])
  @@index([isCritical])
  @@index([lastOrderDate])
}

model ProviderOrder {
  id                   String                  @id @default(cuid())
  providerId           String
  userId               String
  amount               Float                   @default(0)
  status               ProviderOrderStatus     @default(PENDING)
  orderDate            DateTime                @default(now())
  expectedDeliveryDate DateTime?
  type                 ProviderOrderType
  description          String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  files                ProviderFile[]          @relation("OrderFiles")
  Provider             Provider                @relation(fields: [providerId], references: [id], onDelete: Cascade)
  User                 User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment              ProviderPayment?
  timelineEvents       ProviderTimelineEvent[]

  @@index([providerId])
  @@index([userId])
  @@index([status])
}

model ProviderPayment {
  id             String                  @id @default(cuid())
  providerId     String
  userId         String
  amount         Float
  paymentDate    DateTime
  concept        String?
  notes          String?
  createdAt      DateTime                @default(now())
  method         String?
  orderId        String?                 @unique
  status         ProviderPaymentStatus   @default(PAID)
  files          ProviderFile[]
  order          ProviderOrder?          @relation(fields: [orderId], references: [id])
  Provider       Provider                @relation(fields: [providerId], references: [id], onDelete: Cascade)
  User           User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  timelineEvents ProviderTimelineEvent[]

  @@index([providerId])
  @@index([userId])
  @@index([paymentDate])
  @@index([status])
}

model ProviderTask {
  id             String                  @id @default(cuid())
  providerId     String
  userId         String
  title          String
  description    String?
  status         TaskStatus              @default(PENDING)
  priority       TaskPriority            @default(MEDIUM)
  dueDate        DateTime?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  Provider       Provider                @relation(fields: [providerId], references: [id], onDelete: Cascade)
  User           User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  timelineEvents ProviderTimelineEvent[]

  @@index([providerId])
  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

model ProviderNote {
  id             String                  @id @default(cuid())
  providerId     String
  userId         String
  content        String
  createdAt      DateTime                @default(now())
  Provider       Provider                @relation(fields: [providerId], references: [id], onDelete: Cascade)
  User           User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  timelineEvents ProviderTimelineEvent[]

  @@index([providerId])
  @@index([userId])
  @@index([createdAt])
}

model ProviderContactLog {
  id          String              @id @default(cuid())
  providerId  String
  userId      String
  contactType ProviderContactType
  subject     String?
  notes       String?
  createdAt   DateTime            @default(now())
  Provider    Provider            @relation(fields: [providerId], references: [id], onDelete: Cascade)
  User        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([userId])
}

model ProviderFile {
  id                    String                  @id @default(cuid())
  providerId            String
  userId                String
  name                  String
  url                   String
  category              ProviderFileCategory
  group                 String?
  notes                 String?
  size                  Int?
  type                  String?
  createdAt             DateTime                @default(now())
  orderId               String?
  paymentId             String?
  order                 ProviderOrder?          @relation("OrderFiles", fields: [orderId], references: [id])
  payment               ProviderPayment?        @relation(fields: [paymentId], references: [id])
  Provider              Provider                @relation(fields: [providerId], references: [id], onDelete: Cascade)
  User                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  ProviderTimelineEvent ProviderTimelineEvent[]

  @@index([providerId])
  @@index([userId])
  @@index([category])
  @@index([orderId])
  @@index([paymentId])
}

model ProviderTimelineEvent {
  id           String                    @id @default(cuid())
  userId       String
  providerId   String
  type         ProviderTimelineEventType
  noteId       String?
  orderId      String?
  paymentId    String?
  taskId       String?
  createdAt    DateTime                  @default(now())
  fileId       String?
  ProviderFile ProviderFile?             @relation(fields: [fileId], references: [id])
  note         ProviderNote?             @relation(fields: [noteId], references: [id])
  order        ProviderOrder?            @relation(fields: [orderId], references: [id])
  payment      ProviderPayment?          @relation(fields: [paymentId], references: [id])
  Provider     Provider                  @relation(fields: [providerId], references: [id], onDelete: Cascade)
  task         ProviderTask?             @relation(fields: [taskId], references: [id])
  User         User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([userId])
}

model Service {
  id        String     @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime   @default(now())
  User      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  providers Provider[] @relation("ProviderToService")

  @@unique([userId, name])
  @@index([userId])
}

enum AlertType {
  HOT_LEAD
  SCORE_DROP
  HIGH_INTENT
  CONVERSION_RISK
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum EventPriority {
  LOW
  MEDIUM
  HIGH
}

enum EventSource {
  LEAD
  SALE
  MANUAL
  AUTOMATION
  BOOKING
}

enum EventStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum EventType {
  RESERVA
  LLAMADA
  REUNION
  TAREA
  SEGUIMIENTO
  PAGO
  ENTREGA
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  QUALIFIED
  LOST
  CONVERTED
}

enum LeadTemp {
  HOT
  WARM
  COLD
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum UserRole {
  USER
  ADMIN
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum TransactionOrigin {
  MANUAL
  AUTOMATIC
}

enum ExpenseFrequency {
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

enum BudgetPeriod {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum GoalPriority {
  LOW
  MEDIUM
  HIGH
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum FinanceAlertType {
  HIGH_EXPENSE
  BUDGET_EXCEEDED
  CASHFLOW_RISK
  UNUSUAL_PATTERN
  GOAL_DEADLINE
  RECURRING_PAYMENT
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IntegrationCategory {
  PAYMENTS
  PHONE
  BOOKING
  MARKETING
  ORDERS
  OPERATIONS
  ANALYTICS
  OTHER
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  PENDING
}

enum LogType {
  CONNECT
  DISCONNECT
  SYNC
  WEBHOOK
  ERROR
  CONFIG_UPDATE
}

enum Sector {
  restaurante
  gimnasio
  taller_mecanico
  inmobiliaria
  tienda_fisica
  servicios_domicilio
  eventos
  other
}

enum AdminAction {
  ROLE_CHANGED
  PLAN_CHANGED
  USER_IMPERSONATED
  USER_FORCE_LOGOUT
  USER_BLOCKED
  USER_UNBLOCKED
  USER_DEACTIVATED
  USER_ACTIVATED
  ONBOARDING_RESET
  BACKUP_TRIGGERED
  BACKUP_RESTORED
  TELEGRAM_COMMAND_SENT
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum BackupType {
  MANUAL
  SCHEDULED
  PRE_RESTORE
}

enum TaskStatus {
  PENDING
  DONE
  CANCELLED
}

enum ReminderStatus {
  PENDING
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum TaskType {
  CALL
  EMAIL
  MEETING
  MANUAL
}

enum CalendarSyncProvider {
  GOOGLE
  APPLE
}

enum CalendarSyncOperation {
  CREATE
  UPDATE
  DELETE
}

enum CalendarSyncJobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum ProviderStatus {
  ACTIVE
  PAUSED
  BLOCKED
  OK
  PENDING
  ISSUE
}

enum ProviderDependency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ProviderOperationalState {
  OK
  ATTENTION
  RISK
}

enum ProviderOrderStatus {
  PENDING
  COMPLETED
  CANCELLED
  RECEIVED
  DELAYED
  PAID
  DRAFT
  ISSUE
  CLOSED
}

enum ProviderPaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

enum ProviderOrderType {
  MATERIAL
  SERVICE
  SUBSCRIPTION
  ONE_OFF
  ONE_TIME
  RECURRING
}

enum ProviderContactType {
  EMAIL
  CALL
  REMINDER
  CALENDAR
  EXTERNAL_LINK
}

enum ProviderFileCategory {
  INVOICE
  ORDER
  CONTRACT
  OTHER
}

enum ProviderTimelineEventType {
  ORDER
  PAYMENT
  NOTE
  TASK
  FILE
}
