generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AIInsight {
  id         String   @id
  userId     String
  leadId     String?
  type       String
  message    String
  confidence Float    @default(0.5)
  action     String?
  priority   String   @default("MEDIUM")
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  Lead       Lead?    @relation(fields: [leadId], references: [id])
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([priority])
  @@index([read])
  @@index([type])
  @@index([userId])
}

model AIPrediction {
  id            String   @id
  userId        String
  date          DateTime
  expectedSales Int
  scenario      String
  confidence    Float    @default(0.5)
  metadata      Json?
  createdAt     DateTime @default(now())
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([date])
  @@index([scenario])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model AiLog {
  id          String   @id
  leadId      String?
  userId      String
  prompt      String
  response    Json
  model       String   @default("gpt-4o-mini")
  tokens      Int?
  score       Int?
  segment     String?
  probability Float?
  createdAt   DateTime @default(now())
  Lead        Lead?    @relation(fields: [leadId], references: [id])
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([model])
  @@index([userId])
}

model Alert {
  id        String   @id
  userId    String
  leadId    String?
  type      String
  title     String
  message   String
  priority  String   @default("MEDIUM")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  Lead      Lead?    @relation(fields: [leadId], references: [id])
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([priority])
  @@index([read])
  @@index([type])
  @@index([userId])
}

model ApiKey {
  id        String    @id
  userId    String
  key       String    @unique
  name      String?
  active    Boolean   @default(true)
  lastUsed  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([key])
  @@index([userId])
}

model BusinessProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  sector    String
  name      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RestaurantMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  salesToday      Float?
  openTickets     Int?
  tablesOccupied  Int?
  activeEmployees Int?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model GymMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  activeMembers   Int?
  renewals        Int?
  todayCheckins   Int?
  pendingPayments Int?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model WorkshopMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  openOrders      Int?
  vehiclesOnSite  Int?
  monthlyRevenue  Float?
  deliveriesToday Int?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model RealEstateMetrics {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  activeLeads     Int?
  visitsToday     Int?
  monthlyClosings Int?
  commissions     Float?
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model RetailMetrics {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime @default(now())
  dailySales    Float?
  lowStock      Int?
  averageTicket Float?
  suppliers     Int?
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model HomeServiceMetrics {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @default(now())
  appointmentsToday Int?
  activeTechnicians Int?
  pendingInvoices   Int?
  closedJobs        Int?
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model EventMetrics {
  id             String   @id @default(cuid())
  userId         String
  date           DateTime @default(now())
  reservations   Int?
  capacity       Int?
  revenue        Float?
  upcomingEvents Int?
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model GenericMetrics {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime @default(now())
  totalRevenue  Float?
  activeClients Int?
  openTasks     Int?
  satisfaction  Float?
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([userId])
}

model CalendarEvent {
  id            String        @id
  userId        String
  clientId      String?
  title         String
  type          EventType
  status        EventStatus   @default(PENDING)
  start         DateTime
  end           DateTime
  priority      EventPriority @default(MEDIUM)
  source        EventSource   @default(MANUAL)
  notes         String?
  assignedTo    String?
  reminders     Int[]         @default([])
  color         String?       @default("bg-blue-500")
  clientName    String?
  clientEmail   String?
  clientPhone   String?
  googleEventId String?       @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  Client        Client?       @relation(fields: [clientId], references: [id])
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([googleEventId])
  @@index([start])
  @@index([status])
  @@index([type])
  @@index([userId])
}

model Client {
  id     String @id @default(cuid())
  userId String

  name  String?
  email String?
  phone String?
  notes String?

  totalSpent Float  @default(0)
  currency   String @default("EUR")

  source String?
  page   String?

  conversionSource  String?
  conversionProduct String?

  // üîÅ 1:1 Lead ‚Üí Client (conversi√≥n REAL)
  convertedFromLeadId String? @unique
  convertedFromLead   Lead?   @relation("LeadToClient", fields: [convertedFromLeadId], references: [id])

  firstScore   Int @default(0)
  initialScore Int @default(0)
  finalScore   Int @default(0)

  conversionTime Int?
  timeToConvert  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîÅ 1:N Client ‚Üí Leads (hist√≥rico / CRM)
  leads Lead[] @relation("ClientLeads")

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  CalendarEvent CalendarEvent[]
  Sale          Sale[]
  transactions  Transaction[]

  @@index([createdAt])
  @@index([email])
  @@index([page])
  @@index([source])
  @@index([userId])
}

model Event {
  id        String   @id
  leadId    String?
  userId    String
  type      String
  url       String
  element   Json?
  data      Json
  sessionId String?
  visitorId String?
  createdAt DateTime @default(now())
  Lead      Lead?    @relation(fields: [leadId], references: [id])
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([sessionId])
  @@index([type])
  @@index([userId])
  @@index([visitorId])
}

model FinancialRecord {
  id            String   @id
  userId        String
  type          String
  amount        Float
  category      String
  paymentMethod String
  date          DateTime @default(now())
  note          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([date])
  @@index([type])
  @@index([userId])
}

model Lead {
  id                    String     @id @default(cuid())
  userId                String
  websiteId             String?
  email                 String?
  name                  String?
  phone                 String?
  message               String?
  source                String     @default("WEB")
  formId                String?
  status                String     @default("NEW")
  leadStatus            LeadStatus @default(NEW)
  temperature           LeadTemp?
  page                  String?
  lastAction            String?
  lastActionAt          DateTime?
  actions               Json?
  aiPrediction          Float?
  aiReasoning           String?
  aiSegment             String?
  converted             Boolean    @default(false)
  validationStatus      String     @default("PENDING")
  category              String?
  priority              String     @default("MEDIUM")
  tags                  String[]   @default([])
  notes                 String?
  ip                    String?
  country               String?
  device                String?
  userAgent             String?
  spamScore             Float      @default(0)
  score                 Int        @default(0)
  stageId               String?
  interactions          Json?
  conversionProbability Float?
  aiUrgency             String?
  aiLastCheck           DateTime?
  finalScore            Int?
  conversionTime        Int?
  metadata              Json?
  clientId              String?
  convertedAt           DateTime?
  conversionSource      String?
  conversionProduct     String?
  allowedDomain         String?
  aiReason              String?
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  // Relaci√≥n N:1 ‚Üí Lead pertenece a un Client (CRM normal)
  client Client? @relation("ClientLeads", fields: [clientId], references: [id])

  // Relaci√≥n 1:1 ‚Üí Lead convertido en Client
  convertedClient Client? @relation("LeadToClient")

  User    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  Website Website?       @relation(fields: [websiteId], references: [id])
  stage   PipelineStage? @relation(fields: [stageId], references: [id])

  AIInsight     AIInsight[]
  AiLog         AiLog[]
  Alert         Alert[]
  Event         Event[]
  LeadAIInsight LeadAIInsight?
  LeadAlert     LeadAlert[]
  LeadEvent     LeadEvent[]
  TrackingEvent TrackingEvent[]
  activities    Activity[]
  leadScores    LeadScore[]
  aiInsights    AiInsight[]

  @@index([category])
  @@index([clientId])
  @@index([converted])
  @@index([createdAt])
  @@index([email])
  @@index([formId])
  @@index([ip])
  @@index([lastActionAt])
  @@index([leadStatus])
  @@index([page])
  @@index([priority])
  @@index([score])
  @@index([stageId])
  @@index([source])
  @@index([status])
  @@index([temperature])
  @@index([userId])
  @@index([validationStatus])
  @@index([websiteId])
}

model LeadAIInsight {
  id            String   @id
  leadId        String   @unique
  userId        String
  probability   Float
  urgency       String
  explanation   String
  actions       Json
  estimatedTime Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  Lead          Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([probability])
  @@index([urgency])
  @@index([userId])
}

model LeadAlert {
  id          String    @id
  leadId      String
  userId      String
  type        AlertType
  message     String
  reason      String?
  triggeredAt DateTime  @default(now())
  seen        Boolean   @default(false)
  Lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([seen])
  @@index([triggeredAt])
  @@index([type])
  @@index([userId])
}

model LeadEvent {
  id        String   @id
  leadId    String
  userId    String
  type      String
  data      Json
  timestamp DateTime @default(now())
  Lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([timestamp])
  @@index([type])
  @@index([userId])
}

model Notification {
  id        String   @id
  userId    String
  title     String
  message   String
  type      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([read])
  @@index([userId])
}

model Post {
  id          String    @id
  title       String
  slug        String    @unique
  content     String
  excerpt     String?
  category    String    @default("updates")
  published   Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime

  @@index([category])
  @@index([publishedAt])
  @@index([published])
  @@index([slug])
}

model Sale {
  id               String   @id
  userId           String
  clientId         String?
  clientName       String
  clientEmail      String?
  product          String
  category         String?
  price            Float
  discount         Float    @default(0)
  tax              Float    @default(0)
  total            Float
  amount           Float?
  currency         String   @default("EUR")
  provider         String   @default("STRIPE")
  paymentMethod    String
  status           String   @default("PAGADO")
  stripePaymentId  String?
  stripeCustomerId String?
  metadata         Json?
  notes            String?
  saleDate         DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  Client           Client?  @relation(fields: [clientId], references: [id])
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([paymentMethod])
  @@index([saleDate])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripePaymentId])
  @@index([userId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TrackingEvent {
  id        String   @id
  userId    String
  leadId    String?
  sessionId String
  type      String
  page      String
  element   String?
  value     Int?
  metadata  Json?
  createdAt DateTime @default(now())
  Lead      Lead?    @relation(fields: [leadId], references: [id])
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([leadId])
  @@index([page])
  @@index([sessionId])
  @@index([type])
  @@index([userId])
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  name                 String?
  password             String?
  phone                String?
  emailVerified        DateTime?
  role                 UserRole  @default(USER)
  plan                 PlanType  @default(FREE)
  onboardingCompleted  Boolean   @default(false)
  selectedSector       String?
  planId               String?
  isTrial              Boolean   @default(true)
  planStartedAt        DateTime  @default(now())
  planExpiresAt        DateTime?
  billingCycle         String?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  image                String?

  // Admin feature fields
  isBlocked     Boolean   @default(false)
  isActive      Boolean   @default(true)
  blockedAt     DateTime?
  blockedReason String?
  lastLoginAt   DateTime?
  lastActiveAt  DateTime?

  planRelation        Plan?                  @relation(fields: [planId], references: [id])
  AIInsight           AIInsight[]
  AIPrediction        AIPrediction[]
  AiLog               AiLog[]
  Alert               Alert[]
  ApiKey              ApiKey[]
  BusinessProfile     BusinessProfile?
  CalendarEvent       CalendarEvent[]
  Client              Client[]
  Event               Event[]
  FinancialRecord     FinancialRecord[]
  Lead                Lead[]
  LeadAIInsight       LeadAIInsight[]
  LeadAlert           LeadAlert[]
  LeadEvent           LeadEvent[]
  Notification        Notification[]
  restaurantMetrics   RestaurantMetrics[]
  gymMetrics          GymMetrics[]
  workshopMetrics     WorkshopMetrics[]
  realEstateMetrics   RealEstateMetrics[]
  retailMetrics       RetailMetrics[]
  homeServiceMetrics  HomeServiceMetrics[]
  eventMetrics        EventMetrics[]
  genericMetrics      GenericMetrics[]
  Sale                Sale[]
  TrackingEvent       TrackingEvent[]
  Website             Website[]
  accounts            Account[]
  sessions            Session[]
  transactions        Transaction[]
  fixedExpenses       FixedExpense[]
  budgets             Budget[]
  financialGoals      FinancialGoal[]
  financeAlerts       FinanceAlert[]
  cashflowForecasts   CashflowForecast[]
  integrations        Integration[]
  integrationLogs     IntegrationLog[]
  teamMembers         TeamMember[]
  subscriptions       Subscription[]
  payments            Payment[]
  activities          Activity[]
  leadScores          LeadScore[]
  pipelineStages      PipelineStage[]
  automations         Automation[]
  automationLogs      AutomationLog[]
  aiInsights          AiInsight[]
  adminLogs           AdminLog[]             @relation("AdminLogs")
  impersonatedBy      ImpersonationSession[] @relation("ImpersonatedBy")
  impersonationTarget ImpersonationSession[] @relation("ImpersonationTarget")
}

model Plan {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isPublic    Boolean  @default(true)
  price       Float?
  features    String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]

  @@map("plans")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Website {
  id            String        @id
  userId        String
  name          String
  template      String        @default("default")
  business_type String        @default("default")
  city          String        @default("")
  phone         String?
  whatsapp      String?
  email         String?
  services      String[]      @default([])
  description   String?
  status        String        @default("draft")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  palette       Json?
  Lead          Lead[]
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  WebsitePage   WebsitePage[]

  @@index([business_type])
  @@index([status])
  @@index([template])
  @@index([userId])
}

model WebsitePage {
  id        String   @id
  websiteId String
  slug      String
  title     String
  content   Json
  createdAt DateTime @default(now())
  Website   Website  @relation(fields: [websiteId], references: [id], onDelete: Cascade)
}

enum AlertType {
  HOT_LEAD
  SCORE_DROP
  HIGH_INTENT
  CONVERSION_RISK
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum EventPriority {
  LOW
  MEDIUM
  HIGH
}

enum EventSource {
  LEAD
  SALE
  MANUAL
  AUTOMATION
  BOOKING
}

enum EventStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum EventType {
  RESERVA
  LLAMADA
  REUNION
  TAREA
  SEGUIMIENTO
  PAGO
  ENTREGA
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  QUALIFIED
  LOST
  CONVERTED
}

enum LeadTemp {
  HOT
  WARM
  COLD
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum UserRole {
  USER
  ADMIN
}

model Transaction {
  id            String            @id @default(cuid())
  userId        String
  type          TransactionType
  amount        Float
  concept       String
  category      String
  clientId      String?
  paymentMethod String
  status        TransactionStatus @default(PENDING)
  origin        TransactionOrigin @default(MANUAL)
  date          DateTime
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  Client        Client?           @relation(fields: [clientId], references: [id])
  User          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([clientId])
  @@index([date])
  @@index([origin])
  @@index([status])
  @@index([type])
  @@index([userId])
}

model FixedExpense {
  id          String           @id @default(cuid())
  userId      String
  name        String
  amount      Float
  frequency   ExpenseFrequency
  nextPayment DateTime
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  User        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([frequency])
  @@index([nextPayment])
  @@index([userId])
}

model Budget {
  id        String       @id @default(cuid())
  userId    String
  category  String
  limit     Float
  period    BudgetPeriod
  spent     Float        @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  User      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([period])
  @@index([userId])
}

model FinancialGoal {
  id          String       @id @default(cuid())
  userId      String
  title       String
  description String?
  target      Float
  current     Float        @default(0)
  deadline    DateTime
  priority    GoalPriority @default(MEDIUM)
  status      GoalStatus   @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  User        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deadline])
  @@index([priority])
  @@index([status])
  @@index([userId])
}

model FinanceAlert {
  id        String           @id @default(cuid())
  userId    String
  type      FinanceAlertType
  message   String
  severity  AlertSeverity    @default(MEDIUM)
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([read])
  @@index([severity])
  @@index([type])
  @@index([userId])
}

model CashflowForecast {
  id               String   @id @default(cuid())
  userId           String
  date             DateTime
  predictedIncome  Float
  predictedExpense Float
  predictedNet     Float
  confidence       Float
  factors          Json
  createdAt        DateTime @default(now())
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([userId])
}

model TeamMember {
  id        String   @id @default(cuid())
  userId    String
  email     String
  role      String   @default("USER")
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@index([email])
  @@index([userId])
}

model Subscription {
  id                String   @id @default(cuid())
  userId            String
  plan              String
  status            String   @default("ACTIVE")
  stripeSubId       String   @unique
  currentPeriodEnd  DateTime
  cancelAtPeriodEnd Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeSubId])
  @@index([userId])
  @@index([status])
}

model Payment {
  id                    String   @id @default(cuid())
  userId                String
  amount                Int
  currency              String   @default("EUR")
  status                String   @default("PENDING")
  invoiceUrl            String?
  stripePaymentIntentId String?
  createdAt             DateTime @default(now())
  User                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([stripePaymentIntentId])
}

model Integration {
  id         String              @id @default(cuid())
  userId     String
  name       String
  provider   String
  category   IntegrationCategory
  status     IntegrationStatus   @default(DISCONNECTED)
  config     Json?
  apiKey     String?
  webhookUrl String?
  lastSync   DateTime?
  settings   Json?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  User       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs       IntegrationLog[]

  @@index([category])
  @@index([provider])
  @@index([status])
  @@index([userId])
}

model IntegrationLog {
  id            String      @id @default(cuid())
  userId        String
  integrationId String
  type          LogType
  action        String
  data          Json?
  success       Boolean     @default(true)
  error         String?
  metadata      Json?
  createdAt     DateTime    @default(now())
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  Integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([integrationId])
  @@index([success])
  @@index([type])
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum TransactionOrigin {
  MANUAL
  AUTOMATIC
}

enum ExpenseFrequency {
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

enum BudgetPeriod {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum GoalPriority {
  LOW
  MEDIUM
  HIGH
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum FinanceAlertType {
  HIGH_EXPENSE
  BUDGET_EXCEEDED
  CASHFLOW_RISK
  UNUSUAL_PATTERN
  GOAL_DEADLINE
  RECURRING_PAYMENT
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IntegrationCategory {
  PAYMENTS
  PHONE
  BOOKING
  MARKETING
  ORDERS
  OPERATIONS
  ANALYTICS
  OTHER
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  PENDING
}

enum LogType {
  CONNECT
  DISCONNECT
  SYNC
  WEBHOOK
  ERROR
  CONFIG_UPDATE
}

model Activity {
  id          String   @id @default(cuid())
  userId      String // Add userId for relation
  leadId      String
  type        String // email, call, meeting, note, etc.
  title       String
  description String?
  metadata    Json? // additional data like email content, call duration, etc.
  createdAt   DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadId])
  @@index([createdAt])
  @@index([type])
}

model LeadScore {
  id        String   @id @default(cuid())
  userId    String
  leadId    String
  score     Int
  rule      String // the scoring rule that triggered this
  points    Int // points added/subtracted
  metadata  Json? // additional context
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadId])
  @@index([createdAt])
}

model PipelineStage {
  id        String   @id @default(cuid())
  userId    String
  name      String
  order     Int
  color     String   @default("#6366f1")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads     Lead[]

  @@unique([userId, order])
  @@index([userId])
}

model Automation {
  id          String          @id @default(cuid())
  userId      String
  name        String
  description String?
  trigger     Json // trigger conditions
  actions     Json // actions to execute
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  User        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs        AutomationLog[]

  @@index([userId])
  @@index([active])
}

model AutomationLog {
  id           String     @id @default(cuid())
  userId       String
  automationId String
  leadId       String?
  action       String
  result       String
  error        String?
  executedAt   DateTime   @default(now())
  User         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  Automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([automationId])
  @@index([leadId])
  @@index([executedAt])
}

model AiInsight {
  id         String   @id @default(cuid())
  userId     String
  leadId     String
  type       String // prediction, recommendation, alert, etc.
  title      String
  content    String
  confidence Float    @default(0.5)
  metadata   Json? // additional AI data
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leadId])
  @@index([type])
  @@index([createdAt])
}

enum Sector {
  restaurante
  gimnasio
  taller_mecanico
  inmobiliaria
  tienda_fisica
  servicios_domicilio
  eventos
  other
}

// ============================================
// ADMIN PANEL EXTENSIONS
// ============================================

model AdminLog {
  id          String      @id @default(cuid())
  adminId     String
  adminEmail  String
  action      AdminAction
  targetType  String? // "USER", "BACKUP", "SYSTEM"
  targetId    String?
  targetEmail String?
  metadata    Json? // Additional context
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  admin User @relation("AdminLogs", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([targetId])
  @@index([createdAt])
  @@map("admin_logs")
}

enum AdminAction {
  ROLE_CHANGED
  PLAN_CHANGED
  USER_IMPERSONATED
  USER_FORCE_LOGOUT
  USER_BLOCKED
  USER_UNBLOCKED
  USER_DEACTIVATED
  USER_ACTIVATED
  ONBOARDING_RESET
  BACKUP_TRIGGERED
  BACKUP_RESTORED
  TELEGRAM_COMMAND_SENT
}

model ImpersonationSession {
  id           String    @id @default(cuid())
  adminId      String
  targetUserId String
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  ipAddress    String?

  admin      User @relation("ImpersonatedBy", fields: [adminId], references: [id], onDelete: Cascade)
  targetUser User @relation("ImpersonationTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetUserId])
  @@index([startedAt])
  @@map("impersonation_sessions")
}

model BackupMetadata {
  id           String       @id @default(cuid())
  filename     String
  size         BigInt
  location     String // rclone path
  triggeredBy  String? // admin ID
  status       BackupStatus
  type         BackupType
  createdAt    DateTime     @default(now())
  completedAt  DateTime?
  errorMessage String?

  @@index([status])
  @@index([createdAt])
  @@map("backup_metadata")
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum BackupType {
  MANUAL
  SCHEDULED
  PRE_RESTORE
}
